name: Build, Push Docker Image & Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'   # trigger เมื่อ push Git tag เช่น v1.1.0

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Login Docker Hub
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. Build & Push Docker Image (multi-arch)
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            wachrwisw12/skko-gateway-auth:latest
            wachrwisw12/skko-gateway-auth:${{ github.sha }}
            wachrwisw12/skko-gateway-auth:${{ github.ref_name }}

      # 5. Generate release notes from CHANGELOG.md
      - name: Get release notes
        id: release_notes
        run: |
          TAG=${GITHUB_REF_NAME}
          NOTES=$(awk "/^## ${TAG}/,/^## / {if(!/^## /) print}" CHANGELOG.md)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 6. Create GitHub Release with notes
      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.notes }}
          token: ${{ secrets.GITHUB_TOKEN }} 
          